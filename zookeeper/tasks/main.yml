
- name: create zookeeper user
  user:
   name: zookeeper
   shell: /bin/bash
   home: /home/zookeeper

- name: make dir for zookeeper
  file:
   path: /home/zookeeper/ha-cluster/
   state: directory
   owner: zookeeper
   group: zookeeper

- name: make dir for zookeeper data
  file:
   path: /home/zookeeper/ha-cluster/data
   state: directory
   owner: zookeeper
   group: zookeeper

- name: download zookeeper
  get_url:
   url: https://archive.apache.org/dist/zookeeper/{{zookeeper_version}}/apache-{{zookeeper_version}}-bin.tar.gz
   dest: /home/zookeeper/ha-cluster/
   owner: zookeeper
   group: zookeeper

- name: unarhive zookeeper
  unarchive:
   src: /home/zookeeper/ha-cluster/apache-{{zookeeper_version}}-bin.tar.gz
   dest: /home/zookeeper/ha-cluster/
   remote_src: yes
   owner: zookeeper
   group: zookeeper

# Necessary, given https://github.com/ansible/ansible/issues/35426
- name: Fix permissions on the extract directory and sub-directories
  file:
    path: /home/zookeeper/ha-cluster/
    owner: zookeeper
    group: zookeeper
    recurse: yes

- name: make dir for zookeeper conf
  file:
   path: /home/zookeeper/ha-cluster/apache-{{zookeeper_version}}-bin/conf
   state: directory
   owner: zookeeper
   group: zookeeper

- name: add zookeeper env
  lineinfile:
   dest=/home/zookeeper/.bashrc
   line='export ZOOKEEPER_HOME=/home/zookeeper/ha-cluster/apache-{{zookeeper_version}}-bin'

- name: generate zoo.cfg
  template:
   src: zoo.cfg.j2
   dest: /home/zookeeper/ha-cluster/apache-{{zookeeper_version}}-bin/conf/zoo.cfg
   owner: zookeeper
   group: zookeeper

- name: generate myid
  template:
   src: myid.j2
   dest: /home/zookeeper/ha-cluster/data/myid
   owner: zookeeper
   group: zookeeper

   #- name: Check that the somefile.conf exists
   #stat:
   # path: /home/zookeeper/data/zookeeper_server.pid
   #register: stat_result

- name: make dir for zookeeper 
  file:
   path: /home/zookeeper/ha-cluster/apache-zookeeper-3.5.6-bin/logs
   state: directory
   owner: zookeeper
   group: zookeeper   

- name: start zk-server
  become: yes
  #when: stat_result.stat.exists == True
  shell: runuser -l zookeeper -c '/home/zookeeper/ha-cluster/apache-{{zookeeper_version}}-bin/bin/zkServer.sh start' 

  #requirment installed hadoop
  #- name: start zkfc format on NN1
  #when: "'namenode1' in inventory_hostname"
  #shell: hdfs zkfc -formatZK

  #- name: start zkfc on all nodes
  #shell: $HADOOP_HOME/sbin/hadoop-daemon.sh start zkfc

